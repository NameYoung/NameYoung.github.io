

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/avatar.png">
  <link rel="icon" type="image/png" href="/images/avatar.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Young">
  <meta name="keywords" content="">
  <title>Globalization Date Transfer (三) - Framework date handler - Young&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"nameyoung.github.io","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  <header style="height: 40vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Young</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/images/great-wall.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Globalization Date Transfer (三) - Framework date handler">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-07-13 22:48" pubdate>
        2021年7月13日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      1.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      17
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Globalization Date Transfer (三) - Framework date handler</h1>
            
            <div class="markdown-body">
              <div class="note note-info">
            <p>How the framework or library handle date?</p>
          </div>

<a id="more"></a>

<h1 id="Spring-MVC"><a href="#Spring-MVC" class="headerlink" title="Spring MVC"></a>Spring MVC</h1><h2 id="RequestParam"><a href="#RequestParam" class="headerlink" title="@RequestParam"></a>@RequestParam</h2><h3 id="java-util-Date"><a href="#java-util-Date" class="headerlink" title="java.util.Date"></a>java.util.Date</h3><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs livescript">RequestParamMethodArgumentResolver.resolveArgument<br>  -&gt; WebDataBinder.convertIfNecessary (create <span class="hljs-keyword">by</span> ServletRequestDataBinderFactory)<br>    -&gt; SimpleTypeConverter.convertIfNecessary<br>      -&gt; TypeConverterDelegate(SimpleTypeConverter)<br>        -&gt; SimpleTypeConverter.ConversionService.convert<br>          -&gt; GenericConverter(FormattingConversionService$AnnotationParserConverter).converter<br>            -&gt; <span class="hljs-number">1.</span><span class="hljs-built_in">Set</span> pattern info… (<span class="hljs-keyword">if</span> using @DateTimeFormat)<br>            -&gt; <span class="hljs-number">2.</span>ParserConverter.converter<br>              -&gt; DateFormatter.parse<br>                -&gt;SimpleDateFormat.parse (默认服务器时区)<br></code></pre></td></tr></table></figure>

<h3 id="java-time"><a href="#java-time" class="headerlink" title="java.time.*"></a>java.time.*</h3><div class="note note-info">
            <p>本篇以ZonedDateTime为例，演示对java.time.*的处理</p>
          </div>

<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RequestParamMethodArgumentResolver</span>.</span></span>resolveArgument<br>  -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">WebDataBinder</span>.</span></span>convertIfNecessary (create by ServletRequestDataBinderFactory)<br>    -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SimpleTypeConverter</span>.</span></span>convertIfNecessary<br>      -&gt; <span class="hljs-constructor">TypeConverterDelegate(SimpleTypeConverter)</span><br>        -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SimpleTypeConverter</span>.</span><span class="hljs-module"><span class="hljs-identifier">ConversionService</span>.</span></span>convert<br>          -&gt; <span class="hljs-constructor">GenericConverter(FormattingConversionService<span class="hljs-params">$AnnotationParserConverter</span>)</span>.converter<br>            -&gt; <span class="hljs-number">1.</span>Create <span class="hljs-constructor">DateTimeFormatter(<span class="hljs-params">set</span> <span class="hljs-params">pattern</span> <span class="hljs-params">if</span> <span class="hljs-params">using</span> @DateTimeFormat)</span><br>            -&gt; <span class="hljs-number">2.</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ParserConverter</span>.</span></span>converter<br>              -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemporalAccessorParser</span>.</span></span>parse<br>                -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ZonedDateTime</span>.</span></span>parse<br>                  -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DateTimeFormatter</span>.</span></span>parse<br></code></pre></td></tr></table></figure>
<p><img src="/images/date/data-binder-class-diagram.png" srcset="/img/loading.gif" alt="pic 1: DateBinder Class Diagram"></p>
<h2 id="RequestBody-amp-amp-ResponseBody"><a href="#RequestBody-amp-amp-ResponseBody" class="headerlink" title="@RequestBody &amp;&amp; @ResponseBody"></a>@RequestBody &amp;&amp; @ResponseBody</h2><p>MappingJackson2HttpMessageConverter (see <a href="#Jackson">Section Jackson</a>)</p>
<div class="note note-success">
            <p><strong>Tips:</strong></p><ol><li>使用<em>Date</em>做参数时，注意结合注解**@DateTimeFormat**</li><li><strong>@DateTimeFormat</strong> 提供了fallbackPatterns配置，支持多种pattern解析，非常实用</li></ol>
          </div>

<h1 id="Jackson"><a href="#Jackson" class="headerlink" title="Jackson"></a>Jackson</h1><blockquote>
<p>为了支持java.time.*，<strong>Jackson</strong>封装了Jdk8Module插件，<br>详细信息可以看<a target="_blank" rel="noopener" href="https://github.com/FasterXML/jackson-modules-java8">官网</a>，它提供了java.time.*内时间类的Serialize与Deserialize, 引入方式如下：</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<h3 id="java-util-Date-1"><a href="#java-util-Date-1" class="headerlink" title="java.util.Date"></a>java.util.Date</h3><h4 id="Serializer"><a href="#Serializer" class="headerlink" title="Serializer"></a>Serializer</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">objectMapper.writeValue<br>  -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DateSerializer</span>.</span></span>serialize(JsonGenerator)<br>    -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">StdDateFormat</span>.</span></span>format<br>      <span class="hljs-number">1.</span> <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Calendar</span>.</span></span>setTime<br>      <span class="hljs-number">2.</span> 字符串拼接为ISO8601格式<br>      <br></code></pre></td></tr></table></figure>
<h4 id="Deserializer"><a href="#Deserializer" class="headerlink" title="Deserializer"></a>Deserializer</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">objectMapper.readValue<br>  -&gt; <span class="hljs-constructor">DateDeserializer(JsonParser)</span><br>    -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">StdDateFormat</span>.</span></span>parseAsISO8601 (默认<span class="hljs-number">0</span>时区)<br>      <span class="hljs-number">1.</span> 利用正则表达式解析<br>      <span class="hljs-number">2.</span> 设置Calendar值<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Calendar</span>.</span></span>getTime<br></code></pre></td></tr></table></figure>
<div class="note note-info">
            <p>StdDateFormat PATTERN_ISO8601 为：<br><strong>\d\d\d\d[-]\d\d[-]\d\d[T]\d\d[:]\d\d(?:[:]\d\d)?(.\d+)?(Z|[+-]\d\d(?:[:]?\d\d)?)?</strong></p>
          </div>


<h3 id="java-time-1"><a href="#java-time-1" class="headerlink" title="java.time.*"></a>java.time.*</h3><h4 id="Deserializer-1"><a href="#Deserializer-1" class="headerlink" title="Deserializer"></a>Deserializer</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">objectMapper.readValue<br>  -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InstantDeserializer</span>.</span></span>deserialize<br>    -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DateTimeFormatter</span>.</span></span>parse (默认<span class="hljs-number">0</span>时区)<br></code></pre></td></tr></table></figure>
<h4 id="Serializer-1"><a href="#Serializer-1" class="headerlink" title="Serializer"></a>Serializer</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">objectMapper.writeValue<br>  -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ZonedDateTimeSerializer</span>.</span></span>serialize<br>    -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DateTimeFormatter</span>.</span></span>format (默认<span class="hljs-number">0</span>时区)<br></code></pre></td></tr></table></figure>
<h2 id="JsonFormat"><a href="#JsonFormat" class="headerlink" title="@JsonFormat"></a>@JsonFormat</h2><blockquote>
<p>用于对Date的序列化，当添加注解的类型为<em>Date</em>时，pattern即为<em>SimpleDateFormat</em>的pattern，本质改变了DateSerializer._customFormat</p>
</blockquote>
<div class="note note-warning">
            <p><strong>@JsonFormat</strong>也可以用于 <strong>java.time.*</strong></p>
          </div>

<div class="note note-success">
            <p><strong>Tips:</strong></p><ol><li>注意注解 <strong>@JsonFormat</strong> 与 <strong>@DateTimeFormat</strong> 的结合</li><li><strong>@JsonFormat</strong> 对应于<em>SimpleDateFormat</em>，有一定的局限性</li><li>要熟悉<strong>Jackson</strong>的默认反序列化行为（正则匹配的方式非常灵活）</li></ol>
          </div>

<h1 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h1><h2 id="SimpleDateFormat"><a href="#SimpleDateFormat" class="headerlink" title="SimpleDateFormat"></a>SimpleDateFormat</h2><blockquote>
<p>SimpleDateFormat 主要用于格式化与解析 java.util.Date</p>
</blockquote>
<p><img src="/images/SimpleDateFormat.png" srcset="/img/loading.gif" alt="pic 2: SimpleDateFormat pattern"></p>
<h4 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h4><ul>
<li>不直观，潜规则多，需要记忆个字符的具体含义，便捷性差（如yy的解析，取向前80年，向后20年 64-&gt;1964;12-&gt;2012）</li>
<li>ISO支持不灵活，不可以同时支持 +0800 or +08:00</li>
<li>非线程安全</li>
</ul>
<p><img src="/images/WrongYearParse.png" srcset="/img/loading.gif" alt="pic 3: SimpleDateFormat wrong parse"></p>
<div class="note note-info">
            <p>SimpleDateFormat 默认使用server所在时区解析，底层是CalendarBuilder创建Date</p>
          </div>


<h2 id="DateTimeFormatter"><a href="#DateTimeFormatter" class="headerlink" title="DateTimeFormatter"></a>DateTimeFormatter</h2><blockquote>
<p>DateTimeFormatter 主要用于格式化与解析 java.time.*</p>
</blockquote>
<p><img src="/images/DateTimeFormatter.png" srcset="/img/loading.gif" alt="pic 4: DateTimeFormatter"></p>
<h4 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h4><ul>
<li>线程安全</li>
<li>兼容SimpleDateFormat pattern</li>
<li>解析更灵活（DateTimeFormatterBuilder）</li>
<li>使用方便，功能丰富</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 可以同时支持 &#x27;+08&#x27;, &#x27;+0800&#x27;, or &#x27;+08:00&#x27;</span><br>DateTimeFormatter isoZonedDateTimeFormatter = <span class="hljs-keyword">new</span> DateTimeFormatterBuilder()<br>    .parseStrict()<br>    .append(DateTimeFormatter.ISO_DATE_TIME)<br>    .appendPattern(<span class="hljs-string">&quot;[xx][x][xxx]&quot;</span>)<br>    .toFormatter();<br></code></pre></td></tr></table></figure>
<div class="note note-success">
            <p><strong>Tips:</strong></p><ol><li>优先使用<strong>java.time.*</strong> 与 <strong>DateTimeFormatter</strong></li><li>尽量不要用<strong>DateTimeFormatter</strong>兼容历史兼容<em>SimpleDateFormat</em></li><li>尽量使用内置的Formatter 如<strong>DateTimeFormatter.ISO_DATE_TIME</strong></li></ol>
          </div>


<h1 id="Mybatis"><a href="#Mybatis" class="headerlink" title="Mybatis"></a>Mybatis</h1><h2 id="DateTypeHandler"><a href="#DateTypeHandler" class="headerlink" title="DateTypeHandler"></a>DateTypeHandler</h2><h3 id="setParam"><a href="#setParam" class="headerlink" title="setParam"></a>setParam</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 将Date转换为了Timestamp(本质还是Date)，默认为server时区时间</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setNonNullParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-keyword">int</span> i, Date parameter, JdbcType jdbcType)</span></span><br><span class="hljs-function">      <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-comment">// ClientPreparedStatement.setTimestamp()</span><br>    ps.setTimestamp(i, <span class="hljs-keyword">new</span> Timestamp(parameter.getTime()));<br>  &#125;<br></code></pre></td></tr></table></figure>
<h3 id="getParam"><a href="#getParam" class="headerlink" title="getParam"></a>getParam</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getNullableResult</span><span class="hljs-params">(ResultSet rs, String columnName)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  <span class="hljs-comment">// 由Resultset.getTimestamp获取日期数据</span><br>  Timestamp sqlTimestamp = rs.getTimestamp(columnName);<br>  <span class="hljs-keyword">if</span> (sqlTimestamp != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Date(sqlTimestamp.getTime());<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="ZonedDateTimeTypeHandler"><a href="#ZonedDateTimeTypeHandler" class="headerlink" title="ZonedDateTimeTypeHandler"></a>ZonedDateTimeTypeHandler</h2><h3 id="setParam-1"><a href="#setParam-1" class="headerlink" title="setParam"></a>setParam</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 与DateTypeHandler不同，此处调用的是PreparedStatement.setObject</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setNonNullParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-keyword">int</span> i, ZonedDateTime parameter, JdbcType jdbcType)</span></span><br><span class="hljs-function">          <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    ps.setObject(i, parameter);<br>  &#125;<br></code></pre></td></tr></table></figure>
<h3 id="getParam-1"><a href="#getParam-1" class="headerlink" title="getParam"></a>getParam</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> ZonedDateTime <span class="hljs-title">getNullableResult</span><span class="hljs-params">(ResultSet rs, String columnName)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  <span class="hljs-comment">// 调用了ResultSet.getObject </span><br>  <span class="hljs-keyword">return</span> rs.getObject(columnName, ZonedDateTime.class);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>DateTypeHandler</strong>与<strong>ZonedDateTimeTypeHandler</strong>并未对日期做处理，而是直接调用了 PreparedStatement/ResultSet 实现类 ClientPreparedStatement与ResultSetImpl，这两个类是由<strong>Connector/J</strong>实现，细节在下节讲解(see <a href="#JDBC">Section JDBC</a>)</p>
<h1 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h1><blockquote>
<p>Mysql type &lt;-&gt; Java type table<br><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-reference-type-conversions.html">https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-reference-type-conversions.html</a></p>
</blockquote>
<div class="note note-info">
            <p><a class="btn" href="https://insidemysql.com/support-for-date-time-types-in-connector-j-8-0/"  title="Connector/J 8.0.22 的升级与改造" target="_blank">Connector/J 8.0.22 的升级与改造</a><br>简而言之，增加了时区转换的支持</p>
          </div>

<h2 id="JDBC重点参数介绍"><a href="#JDBC重点参数介绍" class="headerlink" title="JDBC重点参数介绍"></a>JDBC重点参数介绍</h2><blockquote>
<p>connectionTimeZone=UTC&amp;forceConnectionTimeZoneToSession=true&amp;preserveInstants=true</p>
</blockquote>
<ul>
<li>connectionTimeZone: 设置client(connection) timezone</li>
<li>forceConnectionTimeZoneToSession: 是否强制session使用connectionTimeZone</li>
<li>preserveInstants: ResultSet是否需要按照connectionTimeZone解析date</li>
</ul>
<h2 id="PreparedStatement-set-param"><a href="#PreparedStatement-set-param" class="headerlink" title="PreparedStatement(set param)"></a>PreparedStatement(set param)</h2><h4 id="ZonedDateTime"><a href="#ZonedDateTime" class="headerlink" title="ZonedDateTime"></a>ZonedDateTime</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">ClientPreparedStatement<br>  -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ClientPreparedQueryBindings</span>.</span></span>setObject<br>        <span class="hljs-comment">//转为timestamp, 时区是JVM时区</span><br>    -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Timestamp</span>.</span></span>value<span class="hljs-constructor">Of(ZonedDateTime.<span class="hljs-params">withZoneSameInstant</span>(SERVER_TIMEZONE)</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">LocalDateTime()</span>) <br>      -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NativeServerSession</span>.</span></span>getDefaultTimezone<br>  -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ClientPreparedQueryBindings</span>.</span></span>bindTimestamp<br>        <span class="hljs-comment">//即connectionTimeZone</span><br>    -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SimpleDateFormat</span>.</span></span>setTimezone (<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NativeServerSession</span>.</span></span>getSessionTimezone) <br>        <span class="hljs-comment">// 将时间转换为session timezone所在时区</span><br>    -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SimpleDateFormat</span>.</span></span>format <br></code></pre></td></tr></table></figure>
<h4 id="Date"><a href="#Date" class="headerlink" title="Date"></a>Date</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">ClientPreparedStatement<br>  -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ClientPreparedQueryBindings</span>.</span></span>bindTimestamp<br>        <span class="hljs-comment">//即connectionTimeZone</span><br>    -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SimpleDateFormat</span>.</span></span>setTimezone (<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NativeServerSession</span>.</span></span>getSessionTimezone) <br>        <span class="hljs-comment">// 将时间转换为session timezone所在时区</span><br>    -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SimpleDateFormat</span>.</span></span>format <br></code></pre></td></tr></table></figure>
<h2 id="ResultSet-get-value"><a href="#ResultSet-get-value" class="headerlink" title="ResultSet(get value)"></a>ResultSet(get value)</h2><h4 id="ZonedDateTime-amp-Date"><a href="#ZonedDateTime-amp-Date" class="headerlink" title="ZonedDateTime &amp; Date"></a>ZonedDateTime &amp; Date</h4><blockquote>
<p>适用于Mysql type datetime&amp;timestamp</p>
</blockquote>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ResultSetImpl</span>.</span></span>getTimestamp<br>  -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ByteArrayRow</span>.</span></span>decodeAndCreateReturnValue<br>    -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">MysqlTextValueDecoder</span>.</span></span>decodeTimestamp<br>      -&gt; <span class="hljs-keyword">new</span> InternalTimestamp  <br>      -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SqlTimestampValueFactory</span>.</span></span>localCreateFromTimestamp <br>        <span class="hljs-comment">//preserveInstants = true &amp; timezone = connectionTimeZone</span><br>        -&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Calendar</span>.</span></span>get<span class="hljs-constructor">Instance(<span class="hljs-params">timezone</span>)</span> <br>        -&gt; <span class="hljs-keyword">new</span> <span class="hljs-constructor">Timestamp(Calendar.<span class="hljs-params">getTimeInMillis</span>()</span>)<br></code></pre></td></tr></table></figure>
<div class="note note-success">
            <p><strong>Tips:</strong></p><ol><li>使用<strong>ZonedDateTime</strong>，应重写handler，避免使用<em>SimpleDateFormat</em></li><li>尽量保证MysqlServer&amp;AppServer统一时区</li><li>日期统一UTC(0时区)存储</li></ol>
          </div>


<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>由以上几个类库处理Date的方式可知:</p>
<ul>
<li>都提供了java.time.*的支持</li>
<li>核心类还是SimpleDateFormat/DateTimeFormatter</li>
</ul>
<p>从<strong>易用性、安全性、合理性</strong>等角度来看，推荐抛弃<em>java.util.Date</em>，使用封装性更好的<strong>java.time.*</strong>，在使用时需要自己编写处理类，特别是对于Mybatis。<br>下一章会讲解避免通过<em>Timestamp/SimpleDateFormat</em>映射<strong>ZonedDateTime</strong></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Web/">Web</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Java/">Java</a>
                    
                      <a class="hover-with-bg" href="/tags/Globalization/">Globalization</a>
                    
                      <a class="hover-with-bg" href="/tags/MyBatis/">MyBatis</a>
                    
                      <a class="hover-with-bg" href="/tags/Jackson/">Jackson</a>
                    
                      <a class="hover-with-bg" href="/tags/Spring/">Spring</a>
                    
                      <a class="hover-with-bg" href="/tags/JDBC/">JDBC</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/01/18/redis-sentinel/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Redis High Available (一)</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/06/22/global-date-transfer-2/">
                        <span class="hidden-mobile">Globalization Date Transfer (二) - java.time.ZonedDateTime</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>









  <script  src="https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js" ></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({"theme":"default"});
    }
  </script>







<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
